<link rel="import" href="../components/polymer/polymer.html">

<dom-module id="scene-analysis">
	<template>
		<div id="player"></div>
	</template>
</dom-module>

<script>
	Polymer({
		is: "scene-analysis",

		ready: function () {
			var tag = document.createElement('script');
			tag.src = "//www.youtube.com/iframe_api";
			var firstScriptTag = document.getElementsByTagName('script')[0];
			firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

			var player;
			window.onYouTubeIframeAPIReady = function() {
				nodecg.sendMessage("loaded", "analysis"); // Let the start scene know we're ready.
				player = new YT.Player("player", {
					height: "1080",
					width: "1920",
					playerVars: {
						autoplay: 1,
						controls: 0,
						modestbranding: 1,
						related: 0
					}
				});
			};

			nodecg.listenFor("analysis-play", function(data) {
				player.setPlaybackRate(data["speed"]);
				player.playVideo(); // Play.
			});

			nodecg.listenFor("analysis-pause", function(data) {
				player.seekTo(data["time"], true);
				player.pauseVideo();
			});

			nodecg.listenFor("analysis-video", function(data) {
				player.loadVideoById({
					videoId: data,
					suggestedQuality: "hd720"
				});
				player.playVideo();
				setTimeout(player.pauseVideo(), 100);
			});
		},

		detached: function() {
			// This is really, really bad. Please don't copy this.
			var handlers = nodecg._messageHandlers;
			for (var i = handlers.length - 1; i >= 0; i--) {
				if (["analysis-play", "analysis-pause", "analysis-video"].indexOf(handlers[i]["messageName"]) >= 0 &&
						handlers[i]["bundleName"] == "vespyr") {
					handlers.splice(i, 1)
				}
			}
			nodecg._messageHandlers = handlers;
		}
	});
</script>
